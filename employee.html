<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Employee Pickup Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="styles.css"/>
  <script src="config.js"></script>
</head>
<body>
<header><h1>Employee Pickup Portal</h1></header>

<section class="card">
  <h2>Check My Requests</h2>
  <input id="searchInput" placeholder="Enter phone (+971...) or Request ID"/>
  <button id="btnSearch">Search</button>
  <div id="results"></div>
</section>

<section class="card">
  <h2>Cancel a Request</h2>
  <input id="cancelId" placeholder="Request ID (UUID)"/>
  <input id="cancelPhone" placeholder="Phone (+971...)"/>
  <button id="btnCancel">Cancel</button>
  <div id="cancelMsg"></div>
</section>

<section class="card">
  <h2>New Request</h2>
  <div class="grid">
    <input id="empId" placeholder="Employee ID"/>
    <input id="fullName" placeholder="Full Name"/>
    <input id="phone" placeholder="+9715xxxxxxx"/>
    <select id="designationSelect"></select>
    <input id="passengers" type="number" min="1"/>
    <input id="date" type="date"/>
    <select id="timeSelect"></select>
    <input id="purpose" placeholder="Purpose of Trip"/>
    <input id="note" placeholder="Special Note (optional)"/>
  </div>
  <div class="map-row">
    <div>
      <h4>Pickup Location</h4>
      <div id="map1" class="map"></div>
      <input id="pickupAddress" placeholder="Pickup address/label"/>
    </div>
    <div>
      <h4>Drop-off Location</h4>
      <div id="map2" class="map"></div>
      <input id="dropoffAddress" placeholder="Drop-off address/label"/>
    </div>
  </div>
  <button id="btnSubmit">Submit Request</button>
  <div id="submitMsg"></div>
</section>

<script>
const { SUPABASE_URL, SUPABASE_ANON_KEY, SMS } = window.APP_CONFIG;
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const isUuid = s => /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s);
const isPhone = s => /^\+971\d{8,9}$/.test(s);

async function rpc(name, args) {
  const { data, error } = await supabase.rpc(name, args);
  if (error) throw error;
  return data;
}

// Load settings: designations, min/max passengers, hours, slot minutes
async function loadSettings() {
  try {
    const settings = await rpc('get_system_settings', {});
    // populate designation dropdown
    const desigSelect = document.getElementById('designationSelect');
    desigSelect.innerHTML = '';
    settings.designations.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d;
      opt.textContent = d;
      desigSelect.appendChild(opt);
    });
    // set passenger min/max
    const pInput = document.getElementById('passengers');
    pInput.min = settings.passenger_min;
    pInput.max = settings.passenger_max;
    pInput.value = settings.passenger_min;
    // store settings for time slots
    window.APP_SETTINGS = settings;
    // update time slots for today's date
    updateTimeSlots(document.getElementById('date').value);
  } catch (e) {
    console.error(e);
  }
}

// Generate time slot options based on settings and date
function updateTimeSlots(dateStr) {
  const select = document.getElementById('timeSelect');
  select.innerHTML = '';
  const settings = window.APP_SETTINGS || {};
  const slotMinutes = settings.slot_minutes || 30;
  const open = settings.hours_open || '08:00';
  const close = settings.hours_close || '20:00';
  if (!dateStr) return;
  const chosenDate = new Date(dateStr);
  // parse open/close
  const [openH, openM] = open.split(':').map(Number);
  const [closeH, closeM] = close.split(':').map(Number);
  // start and end minutes from midnight
  let startMinutes = openH * 60 + openM;
  const endMinutes = closeH * 60 + closeM;
  const now = new Date();
  const isToday = chosenDate.toDateString() === now.toDateString();
  while (startMinutes < endMinutes) {
    const slotHour = Math.floor(startMinutes / 60);
    const slotMin = startMinutes % 60;
    const slotTime = new Date(chosenDate);
    slotTime.setHours(slotHour, slotMin, 0, 0);
    if (!isToday || slotTime > now) {
      const label = slotTime.toTimeString().substring(0,5);
      const option = document.createElement('option');
      option.value = label;
      option.textContent = label;
      select.appendChild(option);
    }
    startMinutes += slotMinutes;
  }
}

async function sendSMS(to, body) {
  if (SMS.provider === 'textbelt') {
    try {
      await axios.post(SMS.endpoint, { phone: to, message: body, key: SMS.key });
    } catch(e) {}
  }
}

document.getElementById('date').addEventListener('change', (e) => {
  updateTimeSlots(e.target.value);
});

document.getElementById('btnSearch').onclick = async () => {
  const q = document.getElementById('searchInput').value.trim();
  const resultsDiv = document.getElementById('results');
  resultsDiv.innerHTML = '';
  try {
    let rows = [];
    if (isUuid(q)) {
      const row = await rpc('get_request_by_id', { p_id: q });
      if (row) rows = [row];
    } else if (isPhone(q)) {
      rows = await rpc('get_requests_by_phone', { p_phone: q });
    } else {
      resultsDiv.textContent = 'Enter a valid +971 phone or Request ID.';
      return;
    }
    if (rows.length === 0) {
      resultsDiv.textContent = 'No records found.';
      return;
    }
    rows.forEach(r => {
      const div = document.createElement('div');
      div.className = 'result';
      div.innerHTML = `
        <b>ID:</b> ${r.id}<br/>
        <b>Status:</b> ${r.status}<br/>
        <b>Requested At:</b> ${new Date(r.requested_at).toLocaleString()}<br/>
        <b>Passengers:</b> ${r.passengers}<br/>
        <b>Pickup:</b> ${r.pickup_location?.address || ''} 
        <button onclick="openMaps(${r.pickup_location?.lat}, ${r.pickup_location?.lng})">Open in Google Maps</button><br/>
        <b>Drop-off:</b> ${r.dropoff_location?.address || ''} 
        <button onclick="openMaps(${r.dropoff_location?.lat}, ${r.dropoff_location?.lng})">Open in Google Maps</button>
      `;
      resultsDiv.appendChild(div);
    });
  } catch(e) {
  resultsDiv.textContent = e.message;
  }
};

window.openMaps = (lat,lng) => {
  if (lat && lng) window.open(`https://maps.google.com/?q=${lat},${lng}`, '_blank');
};

document.getElementById('btnCancel').onclick = async () => {
  const id = document.getElementById('cancelId').value.trim();
  const phone = document.getElementById('cancelPhone').value.trim();
  const msgDiv = document.getElementById('cancelMsg');
  msgDiv.textContent = '';
  if (!isUuid(id) || !isPhone(phone)) {
    msgDiv.textContent = 'Invalid inputs.';
    return;
  }
  if (!confirm('Confirm cancel this request?')) return;
  try {
    const ok = await rpc('cancel_request', { p_id: id, p_phone: phone });
    msgDiv.textContent = ok ? 'Canceled.' : 'Not found or cannot cancel.';
    if (ok) await sendSMS(phone, `Your request ${id} was canceled.`);
  } catch(e) {
    msgDiv.textContent = e.message;
  }
};

document.getElementById('btnSubmit').onclick = async () => {
  const empId = document.getElementById('empId').value.trim();
  const fullName = document.getElementById('fullName').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const designation = document.getElementById('designationSelect').value;
  const passengers = parseInt(document.getElementById('passengers').value, 10);
  const date = document.getElementById('date').value;
  const time = document.getElementById('timeSelect').value;
  const purpose = document.getElementById('purpose').value.trim();
  const note = document.getElementById('note').value.trim();
  const pickupLabel = document.getElementById('pickupAddress').value;
  const dropoffLabel = document.getElementById('dropoffAddress').value;
  const msg = document.getElementById('submitMsg');
  msg.textContent = '';
  if (!empId || !fullName || !isPhone(phone) || !designation || !date || !time || !pickupMarker || !dropMarker) {
    msg.textContent = 'Please fill all required fields.';
    return;
  }
  const requestedAt = new Date(`${date}T${time}:00`);
  const now = new Date();
  if (requestedAt <= now) {
    msg.textContent = 'Cannot book in the past.';
    return;
  }
  const pickup = { lat: pickupMarker.getLatLng().lat, lng: pickupMarker.getLatLng().lng, address: pickupLabel };
  const dropoff = { lat: dropMarker.getLatLng().lat, lng: dropMarker.getLatLng().lng, address: dropoffLabel };
  try {
    const valid = await rpc('validate_employee', { p_employee_id: empId, p_full_name: fullName });
    if (!valid) {
      msg.textContent = 'Employee not found. Contact admin.';
      return;
    }
    const reqId = await rpc('create_request', {
      p_employee_id: empId,
      p_full_name: fullName,
      p_phone: phone,
      p_designation: designation,
      p_passengers: passengers,
      p_purpose: purpose,
      p_note: note,
      p_pickup: pickup,
      p_dropoff: dropoff,
      p_requested_at: requestedAt.toISOString()
    });
    msg.textContent = `Request submitted. ID: ${reqId}`;
    await sendSMS(phone, `Your pickup request ${reqId} was created.`);
  } catch(e) {
    msg.textContent = e.message;
  }
};

let pickupMarker, dropMarker, map1, map2;

function initMap() {
  map1 = L.map('map1').setView([24.4539, 54.3773], 11);
  map2 = L.map('map2').setView([24.4539, 54.3773], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map1);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map2);
  map1.on('click', e => {
    if (pickupMarker) pickupMarker.remove();
    pickupMarker = L.marker(e.latlng).addTo(map1);
    document.getElementById('pickupAddress').value = `lat:${e.latlng.lat.toFixed(6)}, lng:${e.latlng.lng.toFixed(6)}`;
  });
  map2.on('click', e => {
    if (dropMarker) dropMarker.remove();
    dropMarker = L.marker(e.latlng).addTo(map2);
    document.getElementById('dropoffAddress').value = `lat:${e.latlng.lat.toFixed(6)}, lng:${e.latlng.lng.toFixed(6)}`;
  });
}

window.onload = () => {
  initMap();
  const dateInput = document.getElementById('date');
  const today = new Date();
  dateInput.value = today.toISOString().split('T')[0];
  loadSettings();
};
</script>
</body>
</html>
